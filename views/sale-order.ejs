<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sale Order</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar { min-width: 220px; max-width: 220px; background-color: #343a40; min-height: 100vh; color: white; }
    .sidebar a { color: white; text-decoration: none; }
    .sidebar a.active { background-color: #495057; }
    .sidebar a:hover { background-color: #495057; }
    .content { margin-left: 220px; padding: 20px; }

        .card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .card-header {
            background: linear-gradient(45deg, #198754, #20c997);
            color: white;
            border-radius: 15px 15px 0 0;
            text-align: center;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .form-label {
            font-weight: 500;
        }

        .btn-custom {
            background: linear-gradient(45deg, #0d6efd, #0dcaf0);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            transition: 0.3s;
        }

            .btn-custom:hover {
                background: linear-gradient(45deg, #0b5ed7, #0aa2c0);
            }
    </style>
</head>
<body>
  <%- include('includes/sidebar', { SHOPNAME:shopName, activePage: 'sale-order' }) %>
  <div class="content">
    <%- include('includes/header', { pageTitle: 'فروخت بل', user: user }) %>
    <%- include('includes/flash', { success_msg: success_msg, error_msg: error_msg }) %>
<% if (success_msg && success_msg.length) { %>
  <% success_msg.forEach(function(msg) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= msg %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% }) %>
<% } %>

<% if (error_msg && error_msg.length) { %>
  <% error_msg.forEach(function(msg) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= msg %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% }) %>
<% } %>

    <% if (success_msg && success_msg.length) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success_msg %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<% if (error_msg && error_msg.length) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error_msg %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

    <div class="container my-5">
        <div class="card">
            <div class="card-header">
                🛒 غلہ منڈی فروخت بل
            </div>
<div class="card-body">
  <form id="PurchaseOrder" action="/Sale-Order" method="POST">
    <!-- Buyer & Supplier Info -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">تاریخ</label>
        <input style="background-color: lightgray" class="form-control" name="orderDate"
          value="<%= TodayDate.getMonth() + 1 %>/<%= TodayDate.getDate() %>/<%= TodayDate.getFullYear() %>" readonly>
      </div>
      <div class="col-md-6">
        <label class="form-label">پارٹی نام</label><br>
        <select id="customerDropdown" name="customerDropdown" class="form-select">
          <option value=""></option>
          <% customers.forEach(function(cust) { %>
          <option value="<%= cust._id %>" data-name="<%= cust.custName %>">
            <%= cust.custName %>
          </option>
          <% }); %>
        </select>
        <input type="hidden" name="CustomerName" id="CustomerName">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">ٹرک نمبر</label>
        <input type="text" class="form-control" id="TruckNumber" name="truckNumber"
          onblur="Validate('TruckNumberErr', 'TruckNumber')">
        <span id="TruckNumberErr"></span>
      </div> 
      <div class="col-md-3">
        <label class="form-label">آرڈر نمبر</label>
        <input style="background-color: lightgray" type="text" class="form-control" id="OrderNumber" name="orderNo"
          value="<%= orderNo  || 0 %>" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label">بل نمبر</label>
        <input type="text" class="form-control" name="billNo">
      </div>
    </div>

    <!-- Commodity Details -->
    <h5 class="mt-4 mb-3 text-success">🌾 جنس تفصیل </h5>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">جنس</label>
        <select class="form-select" name="commodity" id="commodity">
          <option value="Mungi">Mungi</option>
          <option value="Bajara">Bajara</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">کانٹا وزن (کلو)</label>
        <input type="number" id="conkanWeight" class="form-control" name="ConKanWeight">
      </div>
      <div class="col-md-2">
        <label class="form-label">تعداد</label>
        <input style="background-color: lightgray" id="tadad" type="text" class="form-control" name="tadad" value="0"
          readonly>
      </div>
      <div class="col-md-2">
        <label class="form-label">سٹاک</label>
        <input style="background-color: lightgray" class="form-control" type="text" value="<%= Inventory.value %>"
          readonly>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label" id="bKANKAATlabel">بڑا کانٹا کاٹ</label>
        <input type="number" class="form-control" value="0" id="bKANKAAT" name="bKanKaat">
      </div>

      <div class="col-md-4">
        <label class="form-label" id="bDanaKaatlabel">بار دانہ کاٹ</label>
        <input type="number" class="form-control" value="0" id="bDanaKaat" name="bDanaKaat">
      </div>

      <div class="col-md-4">
        <label class="form-label" id="KamWazanJurmanalabel">کم وزن جرمانہ</label>
        <input type="number" class="form-control" value="0" id="KamWazanJurmana" name="KamWazanJurmana">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">ریٹ فی یونٹ</label>
        <input type="number" class="form-control" id="rate" name="rate" placeholder="e.g. 2500">
      </div>

      <div class="col-md-6">
        <label class="form-label">کمی ریٹ</label>
        <input type="number" class="form-control" id="KameeRate" name="KameeRate" value="0">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label" id="Mazdoorilabel">مزدوری</label>
        <input type="number" class="form-control" name="Mazdoori" id="Mazdoori">
      </div>
      <div class="col-md-6">
        <label class="form-label" id="MazdooriRatelabel">مزدوری ریٹ</label>
        <input type="number" value="10" class="form-control" id="MazdooriRate" name="MazdooriRate">
      </div>
    </div>

    <hr style="border: solid 5px black">

    <div class="text-center">
      <button type="submit" class="btn btn-custom">Save Sale Order</button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Commodity dropdown behavior
document.getElementById("commodity").addEventListener("change", function() {
  let commodityVal = document.getElementById("commodity").value;

  const ids = [
    "bKANKAAT", "bDanaKaat", "KamWazanJurmana",
    "Mazdoori", "MazdooriRate"
  ];
  const labels = [
    "bKANKAATlabel", "bDanaKaatlabel", "KamWazanJurmanalabel",
    "Mazdoorilabel", "MazdooriRatelabel"
  ];

  if (commodityVal === "Bajara") {
    // hide all
    ids.forEach(id => document.getElementById(id).style.display = "none");
    labels.forEach(id => document.getElementById(id).style.display = "none");
  } else {
    // show all
    ids.forEach(id => document.getElementById(id).style.display = "block");
    labels.forEach(id => document.getElementById(id).style.display = "block");
  }
});
        // Calculations
      /*  function CALC3() {
            let MillrComputerweightTxtBx = document.getElementById("conkanWeight")
            let MillrBaraKantaKatTxtBx = document.getElementById("bKANKAAT")
            let MillrBagTxtBx = document.getElementById("tadad")
            let MillrBrokeriTxtBx = document.getElementById("KharKunindaBRoker")
            let MillrMunshianaTxtBx = document.getElementById("munshiana")
       //     let MillrBarDanaKaat = document.getElementById("bDanaKaat")
            let MillrMazdooriTxtBx = document.getElementById("Mazdoori")
            let MillrMazdooriRate = document.getElementById("MazdooriRate")
            let iweight = parseFloat(MillrComputerweightTxtBx.value)
            let bag = Math.round(iweight / 50)
            MillrBagTxtBx.value = bag
            MillrBaraKantaKatTxtBx.value = parseFloat(MillrBagTxtBx.value * 40 / 220)
            let testroundoff = roundoff(parseFloat(MillrBaraKantaKatTxtBx.value));
            MillrBaraKantaKatTxtBx.value = testroundoff
         //  MillrBarDanaKaat.value = iweight * 0.002273
           // testroundoff = roundoff(parseFloat(MillrBarDanaKaat.value))
            // MillrBarDanaKaat.value = testroundoff
            MillrBrokeriTxtBx.value = 8 * bag;
            MillrMunshianaTxtBx.value = 500 * iweight / 11000
            testroundoff = roundoff(parseFloat(MillrMunshianaTxtBx.value))
            MillrMunshianaTxtBx.value = testroundoff

       CALC()
        }

        function CALC() {
            let MillrComputerweightTxtBx = document.getElementById("conkanWeight")
            let MillrBaraKantaKatTxtBx = document.getElementById("bKANKAAT")
            let MillrBagTxtBx = document.getElementById("tadad")
            let MillrBrokeriTxtBx = document.getElementById("KharKunindaBRoker")
            let MillrMunshianaTxtBx = document.getElementById("munshiana")
           // let MillrBarDanaKaat = document.getElementById("bDanaKaat")
            let MillrMazdooriTxtBx = document.getElementById("Mazdoori")
            let MillrMazdooriRate = document.getElementById("MazdooriRate")
        //    let MillrSafiDamage = document.getElementById("SafiDMG")
       //     let MillrKulDamage = document.getElementById("KulDMG")
      //      let MillrSafiKachr = document.getElementById("SafiKachar")
      //      let MillrKulKachr = document.getElementById("KulKachr")
      //      let MillrSafiNami = document.getElementById("SafiNami")
      //      let MillrKulNami = document.getElementById("KulNami")
            let MillrManfiWazn = document.getElementById("ManfiWazan")
            let MillrSafiWazan = document.getElementById("safiWazan")
      //      let MillrKamWzanJurmana = document.getElementById("KamWazanJurmana")
            let MillrRate = document.getElementById("rate")
            let MillrSafiRate = document.getElementById("SafiRate")
          let MillrKamiRate = document.getElementById("KameeRate")
            let MillrRaqm = document.getElementById("KulRaqm")
            let MillrSafiBill = document.getElementById("SafiRaqm")
            let MillrComputerCharges = document.getElementById("KarayaKanta")
            let MillrBaqayaRaqm = document.getElementById("KulSafiRaqm")
            let iweight = parseFloat(MillrComputerweightTxtBx.value)
            let bag = Math.round(iweight / 50)
           
            if (iweight > 0 && iweight != "") {   
        //        MillrSafiDamage.value = (77 / 220) * bag * parseFloat(MillrKulDamage.value)
        //        let testroundoff = roundoff(parseFloat(MillrSafiDamage.value))
        //        MillrSafiDamage.value = testroundoff
       //         MillrSafiKachr.value = (parseFloat(MillrKulKachr.value) * iweight / 100)
       //         testroundoff = roundoff(parseFloat(MillrSafiKachr.value))
       //         MillrSafiKachr.value = testroundoff
         //       MillrSafiNami.value = (parseFloat(MillrKulNami.value) * iweight / 100)
         //       testroundoff = roundoff(parseFloat(MillrSafiNami.value))
         //       MillrSafiNami.value = testroundoff
         //       MillrManfiWazn.value = parseFloat(MillrSafiDamage.value) + parseFloat(MillrSafiKachr.value) + parseFloat(MillrSafiNami.value)
                MillrSafiWazan.value = iweight - parseFloat(MillrBaraKantaKatTxtBx.value)
                let MILLERRATE = parseFloat(MillrRate.value)
                let MILLERsafiWazan = parseFloat(MillrSafiWazan.value)
                if (MILLERRATE > 0 && MILLERsafiWazan > 0) {
                    MillrSafiRate.value = MILLERRATE - MillrKamiRate.value
                  let customerRaqm = parseFloat(MillrSafiWazan.value) / 40 * parseFloat(MillrSafiRate.value)
                    testroundoff = roundoff(customerRaqm)
                    MillrRaqm.value = testroundoff
                    MillrSafiBill.value = MillrRaqm.value - MillrComputerCharges.value - MillrMunshianaTxtBx.value - MillrMazdooriTxtBx.value
                    MillrBaqayaRaqm.value = parseFloat(MillrSafiBill.value) + parseFloat(MillrBrokeriTxtBx.value)
                    // customerRaqm = customerRaqm - parseFloat(MillrComputerCharges) - parseFloat(MillrMunshianaTxtBx) - parseFloat(MillrMazdooriTxtBx) - parseFloat(MillrBrokeriTxtBx) 
                           MillrMazdooriTxtBx.value = parseFloat(MillrMazdooriRate.value) * bag
            testroundoff = roundoff(MillrMazdooriTxtBx.value)
            MillrMazdooriTxtBx.value = testroundoff                
                       }
            }

        } */

(function(_0x3ef37a,_0x3ebdd6){const _0x163ed6=_0x18c0,_0xd703d6=_0x3ef37a();while(!![]){try{const _0x221b51=-parseInt(_0x163ed6(0x1b8))/0x1*(-parseInt(_0x163ed6(0x1b9))/0x2)+parseInt(_0x163ed6(0x1bd))/0x3+-parseInt(_0x163ed6(0x1af))/0x4+-parseInt(_0x163ed6(0x1c4))/0x5+-parseInt(_0x163ed6(0x1b2))/0x6*(parseInt(_0x163ed6(0x1c3))/0x7)+parseInt(_0x163ed6(0x1c5))/0x8+parseInt(_0x163ed6(0x1bc))/0x9*(parseInt(_0x163ed6(0x1ae))/0xa);if(_0x221b51===_0x3ebdd6)break;else _0xd703d6['push'](_0xd703d6['shift']());}catch(_0x2cd1d8){_0xd703d6['push'](_0xd703d6['shift']());}}}(_0x2378,0x276d5));function _0x18c0(_0x3dda84,_0xa361c7){const _0x237873=_0x2378();return _0x18c0=function(_0x18c077,_0xa2ef02){_0x18c077=_0x18c077-0x1ad;let _0x423b21=_0x237873[_0x18c077];return _0x423b21;},_0x18c0(_0x3dda84,_0xa361c7);}function CALC3(){const _0x3ada59=_0x18c0;let _0x2c8971=document[_0x3ada59(0x1be)](_0x3ada59(0x1b7)),_0x2c4716=document[_0x3ada59(0x1be)](_0x3ada59(0x1bf)),_0x58fc24=document[_0x3ada59(0x1be)](_0x3ada59(0x1c1)),_0x26694a=document[_0x3ada59(0x1be)]('KharKunindaBRoker'),_0x254cf8=document[_0x3ada59(0x1be)](_0x3ada59(0x1b3)),_0x2acbdc=document[_0x3ada59(0x1be)]('Mazdoori'),_0x8f6a83=document[_0x3ada59(0x1be)](_0x3ada59(0x1c0)),_0x35337c=parseFloat(_0x2c8971[_0x3ada59(0x1ba)]),_0x117dbd=Math[_0x3ada59(0x1b5)](_0x35337c/0x32);_0x58fc24['value']=_0x117dbd,_0x2c4716[_0x3ada59(0x1ba)]=parseFloat(_0x58fc24['value']*0x28/0xdc);let _0x45feaf=roundoff(parseFloat(_0x2c4716['value']));_0x2c4716[_0x3ada59(0x1ba)]=_0x45feaf,_0x26694a[_0x3ada59(0x1ba)]=0x8*_0x117dbd,_0x254cf8[_0x3ada59(0x1ba)]=0x1f4*_0x35337c/0x2af8,_0x45feaf=roundoff(parseFloat(_0x254cf8['value'])),_0x254cf8[_0x3ada59(0x1ba)]=_0x45feaf,CALC();}function _0x2378(){const _0x4b0400=['1277600GyvDRZ','SafiRaqm','rate','6CcqtnG','munshiana','Mazdoori','round','KharKunindaBRoker','conkanWeight','1773UBjkWx','146MQDNAX','value','ManfiWazan','63BGWVnV','547632aJRyFr','getElementById','bKANKAAT','MazdooriRate','tadad','safiWazan','726404gRJvOe','1316885WtrDGI','637856hkAToF','SafiRate','651910BNYewi'];_0x2378=function(){return _0x4b0400;};return _0x2378();}function CALC(){const _0x2117a0=_0x18c0;let _0x2a3301=document[_0x2117a0(0x1be)](_0x2117a0(0x1b7)),_0x2ee0e4=document[_0x2117a0(0x1be)](_0x2117a0(0x1bf)),_0x25e7fc=document[_0x2117a0(0x1be)](_0x2117a0(0x1c1)),_0x39bdba=document[_0x2117a0(0x1be)](_0x2117a0(0x1b6)),_0x3f2748=document[_0x2117a0(0x1be)]('munshiana'),_0x3a2ce0=document['getElementById'](_0x2117a0(0x1b4)),_0x506f33=document['getElementById']('MazdooriRate'),_0x1044e1=document[_0x2117a0(0x1be)](_0x2117a0(0x1bb)),_0x6c676b=document[_0x2117a0(0x1be)](_0x2117a0(0x1c2)),_0x52b89d=document['getElementById'](_0x2117a0(0x1b1)),_0xb85edd=document[_0x2117a0(0x1be)](_0x2117a0(0x1ad)),_0x3d52ca=document['getElementById']('KameeRate'),_0x263cb4=document[_0x2117a0(0x1be)]('KulRaqm'),_0x1a17f2=document[_0x2117a0(0x1be)](_0x2117a0(0x1b0)),_0x4647ef=document['getElementById']('KarayaKanta'),_0x59aa4d=document[_0x2117a0(0x1be)]('KulSafiRaqm'),_0x410db1=parseFloat(_0x2a3301[_0x2117a0(0x1ba)]),_0xae205=Math[_0x2117a0(0x1b5)](_0x410db1/0x32);if(_0x410db1>0x0&&_0x410db1!=''){_0x6c676b['value']=_0x410db1-parseFloat(_0x2ee0e4[_0x2117a0(0x1ba)]);let _0xa24cf0=parseFloat(_0x52b89d['value']),_0x2ffa10=parseFloat(_0x6c676b['value']);if(_0xa24cf0>0x0&&_0x2ffa10>0x0){_0xb85edd[_0x2117a0(0x1ba)]=_0xa24cf0-_0x3d52ca[_0x2117a0(0x1ba)];let _0x3d3983=parseFloat(_0x6c676b['value'])/0x28*parseFloat(_0xb85edd[_0x2117a0(0x1ba)]);testroundoff=roundoff(_0x3d3983),_0x263cb4[_0x2117a0(0x1ba)]=testroundoff,_0x1a17f2[_0x2117a0(0x1ba)]=_0x263cb4[_0x2117a0(0x1ba)]-_0x4647ef[_0x2117a0(0x1ba)]-_0x3f2748[_0x2117a0(0x1ba)]-_0x3a2ce0[_0x2117a0(0x1ba)],_0x59aa4d[_0x2117a0(0x1ba)]=parseFloat(_0x1a17f2[_0x2117a0(0x1ba)])+parseFloat(_0x39bdba['value']),_0x3a2ce0[_0x2117a0(0x1ba)]=parseFloat(_0x506f33[_0x2117a0(0x1ba)])*_0xae205,testroundoff=roundoff(_0x3a2ce0[_0x2117a0(0x1ba)]),_0x3a2ce0[_0x2117a0(0x1ba)]=testroundoff;}}}

        // Events

        document.getElementById("conkanWeight").addEventListener("keyup", function () {
            CALC3()
        })

        document.getElementById("bKANKAAT").addEventListener("keyup", function () {
            CALC()
        })

  

        document.getElementById("tadad").addEventListener("keyup", function () {
            CALC()
        })

        document.getElementById("KameeRate").addEventListener("keyup", function () {
            CALC()
        })

        document.getElementById("rate").addEventListener("keyup", function () {
             CALC()
        })

        

        document.getElementById("KarayaKanta").addEventListener("keyup", function () {
            CALC()
        })

        document.getElementById("munshiana").addEventListener("keyup", function () {
            CALC()
        })

        document.getElementById("Mazdoori").addEventListener("keyup", function () {
      let MillrComputerweightTxtBx = document.getElementById("conkanWeight")
      let iweight = parseFloat(MillrComputerweightTxtBx.value)
            let bag = Math.round(iweight / 50)
             document.getElementById("MazdooriRate").value = document.getElementById("Mazdoori").value / bag
            CALC()
        })

        document.getElementById("MazdooriRate").addEventListener("keyup", function(){
            CALC()
        })



        document.getElementById("KharKunindaBRoker").addEventListener("keyup", function () {
            let MillrBaqayaRaqm = document.getElementById("KulSafiRaqm")
            let MillrBrokeriTxtBx = document.getElementById("KharKunindaBRoker")
            let MillrSafiBill = document.getElementById("SafiRaqm")
            MillrBaqayaRaqm.value = parseFloat(MillrSafiBill.value) + parseFloat(MillrBrokeriTxtBx.value)
        })
            // Validation
        function Validate(ErrName, FieldName) {
            let ErrId = document.getElementById(ErrName)
            let Field = document.getElementById(FieldName).value
            if (Field == "") {
                ErrId.innerText = `Field must not be empty.`
                ErrId.style.color = "red"
            } else {
                ErrId.innerText = ""
            }
        }
    

     function validate(){
       axios.post('/Purchase-Order').then(() => alert("Success")).catch(() => alert("Some errros"))
     }

            // roundoff
        function roundoff(x) {
            let test
            test = Math.floor(x)
            let test1 = x - test
            if (test1 >= 0.5) {
                test = test + 1
            } else {
                test = test
            }
            return test
        }
$('#customerDropdown').select2({
  placeholder: "",
  allowClear: true,
  dropdownParent: $('body'), // fixes modal/z-index issues
  minimumResultsForSearch: 0 // forces the search box to appear
});

      $('#customerDropdown').on('change', function() {
    const selectedOption = $(this).find('option:selected');
    const custPayDue = parseFloat(selectedOption.data('due')) || 0;
    const custName = selectedOption.data('name');

    $('#CustomerName').val(custName);   // send name in form
    })
    </script>
</body>
</html>
